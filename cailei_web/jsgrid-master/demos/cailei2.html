<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>退库系统</title>
    <link rel="stylesheet" type="text/css" href="demos.css" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../css/jsgrid.css" />
    <link rel="stylesheet" type="text/css" href="../css/theme.css" />

    <script src="../external/jquery/jquery-1.8.3.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.2/themes/cupertino/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script>

    <script src="../src/jsgrid.core.js"></script>
    <script src="../src/jsgrid.load-indicator.js"></script>
    <script src="../src/jsgrid.load-strategies.js"></script>
    <script src="../src/jsgrid.sort-strategies.js"></script>
    <script src="../src/jsgrid.field.js"></script>
    <script src="../src/fields/jsgrid.field.text.js"></script>
    <script src="../src/fields/jsgrid.field.number.js"></script>
    <script src="../src/fields/jsgrid.field.select.js"></script>
    <script src="../src/fields/jsgrid.field.checkbox.js"></script>
    <script src="../src/fields/jsgrid.field.control.js"></script>

    <style>
        .ui-widget *, .ui-widget input, .ui-widget select, .ui-widget button {
            font-family: 'Helvetica Neue Light', 'Open Sans', Helvetica;
            font-size: 14px;
            font-weight: 300 !important;
        }

        .details-form-field input,
        .details-form-field select {
            width: 250px;
            float: right;
        }

        .details-form-field {
            margin: 30px 0;
        }

        .details-form-field:first-child {
            margin-top: 10px;
        }

        .details-form-field:last-child {
            margin-bottom: 10px;
        }

        .details-form-field button {
            display: block;
            width: 100px;
            margin: 0 auto;
        }

        input.error, select.error {
            border: 1px solid #ff9999;
            background: #ffeeee;
        }

        label.error {
            float: right;
            margin-left: 100px;
            font-size: .8em;
            color: #ff6666;
        }
    </style>
</head>
<body>
    <h1>退库数据</h1>

    <div id="detailsDialog">
        <form id="detailsForm">
            <div class="details-form-field">
                <label for="order">订单号:</label>
                <input id="order" name="订单号" type="text" readonly="readonly" />
          </div>
            <div class="details-form-field">
                <label for="name">名字:</label>
                <select id="name" name="名字">
                    <option value="蔡磊">蔡磊</option>
                    <option value="包包">包包</option>
                </select>
            </div>
            <div class="details-form-field">
                <label for="cancell">是否已退库:</label>
                <select id="cancell" name="是否已退库">
                    <option value="0">未退库</option>
                    <option value="1">已退库</option>
                </select>
            </div>
            <div class="details-form-field">
                       <label for="remark">备注:</label>
                       <input id="remark" name="备注" type="text" />
                </div>
            <div class="details-form-field">
                <button type="submit" id="save">修改</button>
            </div>
        </form>
    </div>
   

    <div id="jsGrid"></div>

    <script>
        //let svrurl = "http://localhost:6776/";
        let svrurl = "http://47.92.196.253/";

        itemcancell = [
            { Name: "全部",   Id: -1 },
            { Name: "未退库", Id: 0 },
            { Name: "已退库", Id: 1 }
        ];

        itemintime = [
            { Name: "近三天",   Id: 0 },
            { Name: "近七天", Id: 1 },
            { Name: "近半月", Id: 2 },
            { Name: "近一月", Id: 3 }
        ];

        Date.prototype.Format = function (fmt) { // author: meizz
            var o = {
                "M+": this.getMonth() + 1, // 月份
                "d+": this.getDate(), // 日
                "h+": this.getHours(), // 小时
                "m+": this.getMinutes(), // 分
                "s+": this.getSeconds(), // 秒
                "q+": Math.floor((this.getMonth() + 3) / 3), // 季度
                "S": this.getMilliseconds() // 毫秒
            };
            if (/(y+)/.test(fmt))
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                    return fmt;
        }   

        $(function() {

            $("#jsGrid").jsGrid({
                height: "70%",
                width: "100%",
                autoload:true,
                editing: true,
                paging: true,
                filtering: true,
                pageButtonCount: 5,
                rowClick: function(args) {
                    showDetailsDialog("修改", args.item);
                },
                controller: {
                    loadData: function(filter) {

                        var d = $.Deferred();
                        $.ajax({
                            type: "post",
                            url: svrurl+"cailei?action=GetDataByFiter",
                            data: filter,
                            dataType: "json",
                            success: function(res,status,xhr)  {
                                d.resolve(res.data);
                            },
                            error: function(res,status){
                                console.log(status);
                        }
                        });

                        return d.promise();
                        
                    },
                    updateItem: function(updatingClient) { 
                       
                    }
                    },
                    
                fields: [
                    { name: "ordernum",  title: "订单号",type: "text",width: 150 ,editing: false,visible: true },// 不指定类型，则该field不可编辑
                    { name: "remark",title: "备注",sorting: false,editing: false},
                    { name: "cancell",title: "是否已退库", type: "select", items: itemcancell, valueField: "Id", textField: "Name",selectedIndex: 0},
                    { name: "name",title: "收货员",  width: 150 ,editing: false},
                    { name: "timestamp",title: "收货时间",readOnly: true},
                    { name: "intime",title: "入库时间",readOnly: true,editing: false},
                    { name: "timefilter",title: "最近搜索", type: "select", items: itemintime, valueField: "Id", textField: "Name",selectedIndex: 0}
                   // { name: "timefilter",title: "最近搜索",type:"select",items: db.time, valueField:"Id",textField: "Name",selectedIndex: 0}
                   // { type: "control", modeSwitchButton: false,deleteButton:false }
                ],
            });

            $("#detailsDialog").dialog({
                autoOpen: false,
                width: 400,
                close: function() {
                    $("#detailsForm").validate().resetForm();
                    $("#detailsForm").find(".error").removeClass("error");
                }
            });

            $("#detailsForm").validate({
                rules: {
                    name: "required",
                    cancell: "required"
                },
                messages: {
                    name: "请选择",
                    cancell: "请选择"
                },
                submitHandler: function() {
                    formSubmitHandler();
                }
            });

            var formSubmitHandler = $.noop;

            var showDetailsDialog = function(dialogType, client) {
                $("#cancell").val(client.cancell);
                $("#remark").val(client.remark);
                $("#order").val(client.ordernum);

                formSubmitHandler = function() {
                    saveClient(client);
                };

                $("#detailsDialog").dialog("option", "title", dialogType + " 记录")
                    .dialog("open");
            };

            var saveClient = function(client) {
                client.name =  $("#name").val();
                client.cancell = parseInt($("#cancell").val(),10);
                client.remark = $("#remark").val();
                client.timestamp = new Date().Format("yyyy-MM-dd hh:mm:ss");   
                
                $.ajax({
                    url: svrurl+"cailei?action=UpdateData",
                    data: client,
                    type: "post",
                    dataType: "json",
                    success: function(res,status,xhr) 
                    {                                
                        
                    },
                    error: function(res,status)
                    {
                        
                    }
                });
                $("#jsGrid").jsGrid("updateItem", client);

                $("#detailsDialog").dialog("close");
            };

        });

    </script>
</body>
</html>
